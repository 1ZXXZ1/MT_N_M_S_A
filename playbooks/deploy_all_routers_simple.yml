- name: Deploy configuration to ALL ENABLED MikroTik routers
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
  - name: Load mikrotik variables
    include_vars:
      file: ../vars/mikrotik_vars.yml
      name: mikrotik_vars
  - name: Create list of enabled routers
    set_fact:
      enabled_routers: []
  - name: Add router_rt1 if enabled
    set_fact:
      enabled_routers: '{{ enabled_routers + [''router_rt1''] }}'
    when: mikrotik_vars.router_rt1.enabled | default(false) | bool
  - name: Add router_rt2 if enabled
    set_fact:
      enabled_routers: '{{ enabled_routers + [''router_rt2''] }}'
    when: mikrotik_vars.router_rt2.enabled | default(false) | bool
  - name: Add router_rt3 if enabled
    set_fact:
      enabled_routers: '{{ enabled_routers + [''router_rt3''] }}'
    when: mikrotik_vars.router_rt3.enabled | default(false) | bool
  - name: Add router_rt4 if enabled
    set_fact:
      enabled_routers: '{{ enabled_routers + [''router_rt4''] }}'
    when: mikrotik_vars.router_rt4.enabled | default(false) | bool
  - name: Add router_rt5 if enabled
    set_fact:
      enabled_routers: '{{ enabled_routers + ["router_rt5"] }}'
    when: mikrotik_vars.router_rt5.enabled | default(false) | bool
  - name: Show deployment summary
    debug:
      msg: 'ðŸš€ DEPLOY-ALL: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð’ÐšÐ›Ð®Ð§Ð•ÐÐÐ«Ð• Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ñ‹

        ===================================

        Ð’ÑÐµÐ³Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ‹Ñ… Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ð¾Ð²: {{ enabled_routers | length }}

        Ð¡Ð¿Ð¸ÑÐ¾Ðº:

        {% for router in enabled_routers %}

        - {{ router }}: {{ mikrotik_vars[router].description }} ({{ mikrotik_vars[router].host
        }}) - ðŸŸ¢ Ð’ÐšÐ›Ð®Ð§Ð•Ð

        {% endfor %}

        {% if enabled_routers | length == 0 %}

        â„¹ï¸ ÐÐµÑ‚ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ‹Ñ… Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ

        {% endif %}

        '
  - name: Process each ENABLED router
    include_tasks: process_router.yml
    loop: '{{ enabled_routers }}'
    loop_control:
      loop_var: target_router
      label: '{{ target_router }}'
    vars:
      force_enable: false
      router_config: '{{ mikrotik_vars[target_router] }}'
      common_config: '{{ mikrotik_vars[''mikrotik_common''] }}'
      router_name: '{{ target_router }}'
    when: enabled_routers | length > 0
